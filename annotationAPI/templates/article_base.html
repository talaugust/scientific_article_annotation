<!-- templates/base.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Annotation Test Site</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'annotationAPI/css/bootstrap.css' %}"/>
  <link rel="stylesheet" type="text/css" href="{% static 'annotationAPI/css/annotator.min.css' %}">   
  <script type="text/javascript" src="{% static 'annotationAPI/js/jquery-3.4.1.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'annotationAPI/js/bootstrap.bundle.js' %}"></script>


<!--   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">          
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> -->
</head>
<body>
  <main>
   <div class="container">
    <div class="card mt-4" id="storyContainer">
        <div class="card-header">
            <h2> {{ object.title }} </h2>
        </div>
        <div class="card-body">
          {{ object.text | linebreaks }}
	       <p class="mt-2"> <a href={{object.url}}> link </a>  </p>
        </div>
    </div>
</div>
  </main>
  <script src="{% static 'annotationAPI/js/annotator-full.min.js' %}"></script>
<script>



  // https://docs.djangoproject.com/en/1.11/ref/csrf/#ajax
  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }



  function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }


  function requestWriting($suggestID, currentVal, context, snapshots) {
  // https://docs.djangoproject.com/en/1.11/ref/csrf/#ajax
  var csrftoken = getCookie('csrftoken');
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        console.log("here");
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
      }
    });
  }


  var DEBUG = false; 
  Annotator.Plugin.StoreLogger = function (element) {
  return {
    pluginInit: function () {
      this.annotator
          .subscribe("annotationCreated", function (annotation) {
            console.info(annotation)
          })
          .subscribe("annotationUpdated", function (annotation) {
            console.info("The annotation: %o has just been updated!", annotation)
          })
          .subscribe("annotationDeleted", function (annotation) {
            console.info("The annotation: %o has just been deleted!", annotation)
          })
    }
  }
};

  var content = $('#storyContainer').annotator();
  var article_id = "{{object.id}}"

  content.annotator('addPlugin', 'Permissions');
  content.annotator('addPlugin', 'Tags')
  content.annotator('addPlugin', 'StoreLogger')
  content.annotator('addPlugin', 'Store', {
      // The endpoint of the store on your server.
      prefix: 'http://127.0.0.1:8000/api',

      // Attach the uri of the current page to all annotations to allow search.
      annotationData: {
        'uri': DEBUG? 'https://www.test.com':window.location.href,
        'article': article_id, 
      },
      urls: {
        // These are the default URLs.
        create:  '/annotations/',
        update:  '/annotations/:id/',
        destroy: '/annotations/:id',
        search:  '/annotations/'
      },
      // This will perform a "search" action when the plugin loads. Will
      // request the last 20 annotations for the current url.
      loadFromSearch: {
        'id': DEBUG? 'https://www.test.com':article_id,
        'limit': 20,
      },
    });

  $('#storyContainer').data('annotator').plugins['Permissions'].setUser("3");

  </script>
</body>
</html>
